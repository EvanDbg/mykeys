# MyKeys 企业微信集成与 Docker 部署实施计划

## 目标

将 MyKeys 密码管理工具从 **Telegram + Cloudflare Workers** 架构扩展为支持 **企业微信应用**，并部署到 **Docker 容器**。

---

## User Review Required

> [!IMPORTANT]  
> **企业微信应用配置**：您需要在企业微信管理后台创建自建应用，获取以下配置参数：
> - **CorpID** (企业 ID)
> - **AgentID** (应用 ID)  
> - **Secret** (应用密钥)
> - **Token** (消息回调令牌)
> - **EncodingAESKey** (消息加密密钥)

> [!WARNING]  
> **保留 Telegram 支持**？当前计划会保留 Telegram Bot 代码，同时新增企业微信支持。如果您只需要企业微信，请告知我移除 Telegram 相关代码。

---

## Proposed Changes

### 项目结构重构

从单文件 TypeScript 重构为模块化 Node.js 项目：

```
mykeys/
├── src/
│   ├── core/                    # 核心业务逻辑
│   │   ├── crypto.ts            # AES-256-GCM 加密模块
│   │   ├── storage.ts           # 存储层抽象接口
│   │   ├── storage-sqlite.ts    # SQLite 实现
│   │   ├── session.ts           # 会话管理
│   │   └── password-service.ts  # 密码管理业务逻辑
│   │
│   ├── platforms/               # 平台适配层
│   │   ├── telegram/            # Telegram Bot
│   │   │   ├── handler.ts
│   │   │   └── api.ts
│   │   └── wecom/               # 企业微信
│   │       ├── handler.ts       # 消息处理
│   │       ├── crypto.ts        # 企业微信加解密
│   │       └── api.ts           # API 封装
│   │
│   ├── adapters/                # 运行时适配
│   │   ├── cloudflare.ts        # Cloudflare Workers (原有)
│   │   └── node.ts              # Node.js HTTP 服务
│   │
│   ├── config.ts                # 配置管理
│   └── index.ts                 # 主入口
│
├── Dockerfile
├── docker-compose.yml
├── package.json
└── .env.example
```

---

### Component 1: 核心模块

#### [MODIFY] [crypto.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/core/crypto.ts)
- 将加密逻辑从 `index.ts` 提取为独立模块
- 保持 AES-256-GCM 实现不变
- 导出 `encrypt()`, `decrypt()`, `getKey()` 函数

#### [NEW] [storage.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/core/storage.ts)
- 定义存储接口 `IStorage`
- 方法：`getSecret()`, `saveSecret()`, `searchSecrets()`, `deleteSecret()`

#### [NEW] [storage-sqlite.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/core/storage-sqlite.ts)
- 使用 `better-sqlite3` 实现 SQLite 存储
- 支持本地文件持久化

#### [NEW] [password-service.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/core/password-service.ts)
- 封装密码管理业务逻辑
- 与具体消息平台解耦

---

### Component 2: 企业微信集成

#### [NEW] [wecom/crypto.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/platforms/wecom/crypto.ts)
企业微信消息加解密实现：
```typescript
// 签名验证
function verifySignature(token: string, timestamp: string, nonce: string, 
                         msgSignature: string, echostr?: string): boolean

// 消息解密
function decryptMessage(encodingAESKey: string, encryptedMsg: string): string

// 消息加密
function encryptMessage(encodingAESKey: string, corpId: string, 
                        replyMsg: string): string
```

#### [NEW] [wecom/handler.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/platforms/wecom/handler.ts)
企业微信消息处理：
- GET 请求：URL 验证回调
- POST 请求：消息接收与处理
- XML 解析与构造
- 被动消息回复

#### [NEW] [wecom/api.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/platforms/wecom/api.ts)
企业微信 API 封装：
- `getAccessToken()` - 获取接口调用凭证
- `sendMessage()` - 主动发送消息

---

### Component 3: Node.js 运行时

#### [NEW] [adapters/node.ts](file:///Users/evan/Documents/seafile/Seafile/00_Dev/Github/mykeys/src/adapters/node.ts)
使用 Express.js 创建 HTTP 服务：
```typescript
import express from 'express';

const app = express();

// 企业微信回调
app.get('/wecom/callback', wecomHandler.verifyUrl);
app.post('/wecom/callback', wecomHandler.handleMessage);

// Telegram Webhook (可选保留)
app.post('/telegram/webhook', telegramHandler.handleMessage);

// 健康检查
app.get('/health', (req, res) => res.send('OK'));
```

---

### Component 4: Docker 部署

#### [NEW] Dockerfile
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY dist/ ./dist/
COPY .env.example ./.env
VOLUME ["/app/data"]
EXPOSE 3000
CMD ["node", "dist/index.js"]
```

#### [NEW] docker-compose.yml
```yaml
version: '3.8'
services:
  mykeys:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - ./data:/app/data  # SQLite 数据持久化
    environment:
      - WECOM_CORP_ID=${WECOM_CORP_ID}
      - WECOM_AGENT_ID=${WECOM_AGENT_ID}
      - WECOM_SECRET=${WECOM_SECRET}
      - WECOM_TOKEN=${WECOM_TOKEN}
      - WECOM_ENCODING_AES_KEY=${WECOM_ENCODING_AES_KEY}
      - ENCRYPT_KEY=${ENCRYPT_KEY}
    restart: unless-stopped
```

#### [NEW] .env.example
```env
# 企业微信配置
WECOM_CORP_ID=your_corp_id
WECOM_AGENT_ID=your_agent_id
WECOM_SECRET=your_secret
WECOM_TOKEN=your_token
WECOM_ENCODING_AES_KEY=your_encoding_aes_key

# 加密密钥 (与 Cloudflare 版本相同以兼容数据)
ENCRYPT_KEY=7dfe4d0d0441fe4fcf12627759d0bfe8

# 服务配置
PORT=3000
DATABASE_PATH=/app/data/mykeys.db
```

---

## Verification Plan

### 本地开发测试

```bash
# 1. 安装依赖
npm install

# 2. 编译 TypeScript
npm run build

# 3. 启动本地服务
npm run dev

# 4. 测试健康检查
curl http://localhost:3000/health
```

### Docker 容器测试

```bash
# 1. 构建镜像
docker build -t mykeys .

# 2. 运行容器
docker run -p 3000:3000 -v $(pwd)/data:/app/data --env-file .env mykeys

# 3. 测试健康检查
curl http://localhost:3000/health
```

### 企业微信手动测试

需要您在企业微信管理后台完成以下配置：

1. **创建自建应用**
   - 进入企业微信管理后台 → 应用管理 → 自建应用
   - 创建应用并记录 AgentID 和 Secret

2. **配置接收消息** 
   - 在应用详情页 → 接收消息 → 设置 API 接收
   - 填写 URL: `https://your-server:3000/wecom/callback`
   - 填写 Token 和 EncodingAESKey

3. **测试消息收发**
   - 在企业微信中打开应用
   - 发送 "test" 验证 Bot 响应
   - 发送密码名称测试保存流程
